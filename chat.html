<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>Chat App</title>
</head>
<body>
    <form name="my-form" id="form">
    <div id="chat">
    </div>
    <div id="uchat">
    </div>
    <div id="main">
        <input type="text" value="" id="message"  >
    <input type="submit" value="Send">
</div>
</form> 
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.1.2/axios.min.js"></script>  
<script>
let Form=document.getElementById('form')
let message=document.getElementById('message')
let chat=document.getElementById('chat');
let uchat=document.getElementById('uchat');
const token = localStorage.getItem('token');
Form.addEventListener('submit',addMsg)

let id;
let di;
//setTimeout(()=>{})
document.addEventListener('DOMContentLoaded',()=>{
    //let myobj_deserialized=JSON.parse(localStorage.getItem("myObj"))
   // console.log(msg);
        axios.get(`http://localhost:3000/chat/get?lastmsgid=${0}`,{headers:{'Authorization':token}})
    .then((response)=>{
        console.log(response);
        storage(response.data)
     loadonscreen(response.data)
    let msg=JSON.parse(localStorage.getItem('messages'))
        if(msg==null || msg.length==0){
             id=0;
        }
        else{
             id=msg[msg.length-1].id;
        }
        console.log(msg);   
        console.log(id)
         
         setInterval(()=>{
        axios.get(`http://localhost:3000/chat/get?lastmsgid=${id}`,{headers:{'Authorization':token}})  
    .then((response)=>{
        console.log(response);
         //storage(response.data)
         loadonscreen1(response.data)
    

    })
},1000)  

    })
})

    
    //     axios.get(`http://localhost:3000/chat/get?lastmsgid=${id}`,{headers:{'Authorization':token}})  
    // .then((response)=>{
    //     console.log(response);
    //     storage(response.data)
    //     loadonscreen(response.data)
    // })
    

    

// })

// function get(){
//             axios.get(`http://localhost:3000/chat/get?lastmsgid=${0}`,{headers:{'Authorization':token}})  
//     .then((response)=>{
//         console.log(response);
//      storage(response.data)
//        // loadonscreen(response.data)
//     })

//     }
   
function storage(data){
    let myobj_serialized=JSON.stringify(data.allchats);
localStorage.setItem('messages',myobj_serialized);
console.log(localStorage.getItem('messages'))
}
function loadonscreen1(data){
    let name=data.user.name
    uchat.innerHTML=""
    for(var i=0;i<data.allchats.length;i++){
        if(data.allchats[i].userName==name){
     var li=document.createElement('li');
 li.className='msg';
 li.appendChild(document.createTextNode(`You:${data.allchats[i].message}`))
 uchat.appendChild(li);
        }
        else{
    var li=document.createElement('li');
 li.className='msg';
 li.appendChild(document.createTextNode(`${data.allchats[i].userName}:${data.allchats[i].message}`))
 uchat.appendChild(li); 
}
    }
}
function loadonscreen(data){
let name=data.user.name
    for(var i=0;i<data.allchats.length;i++){
        if(data.allchats[i].userName==name){
     var li=document.createElement('li');
 li.className='msg';
 li.appendChild(document.createTextNode(`You:${data.allchats[i].message}`))
 chat.appendChild(li);
        }
        else{
    var li=document.createElement('li');
 li.className='msg';
 li.appendChild(document.createTextNode(`${data.allchats[i].userName}:${data.allchats[i].message}`))
 chat.appendChild(li);
}

    }
}
function addMsg(e){
    e.preventDefault();
    let Msg={
        message:message.value
    }
    newMsg(Msg)
}

function newMsg(Msg){
    axios.post("http://localhost:3000/chat/post",Msg,{headers:{'Authorization':token}})
     .then((data)=>{
        console.log(data,'33');
     // showonscreen(data);
       document.my-form.reset();
      // get();
     })
     .catch((err)=>{
        console.log(err);
     })

}
function showonscreen(data){
    console.log(data.data.data.message,'41');
var li=document.createElement('li');
 li.className='msg';
 li.appendChild(document.createTextNode(`You:${data.data.data.message}`))
 chat.appendChild(li);
}


</script>
</body>
</html>